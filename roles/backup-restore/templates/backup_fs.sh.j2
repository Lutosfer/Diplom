#!/bin/bash

# Конфигурация
BACKUP_DIR="/backup/media"
MEDIAWIKI_DIR="/var/www/mediawiki"
REMOTE_HOST="84.201.156.241" #ip-monitor01
REMOTE_DIR="/backup/media"
REMOTE_USER="ubuntu"
RETENTION_DAYS=7
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="mediawiki_fs_$TIMESTAMP.tar.gz"

# Создание резервной копии
echo "[$(date)] Начало резервного копирования файловой системы..."
tar -zcf $BACKUP_DIR/$BACKUP_NAME -C $(dirname $MEDIAWIKI_DIR) $(basename $MEDIAWIKI_DIR)
if [ $? -ne 0 ]; then
    echo "[$(date)] Ошибка при создании архива!"
    exit 1
fi

# Передача на удаленный сервер
echo "[$(date)] Передача резервной копии на удаленный сервер..."
scp $BACKUP_DIR/$BACKUP_NAME $REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/
if [ $? -ne 0 ]; then
    echo "[$(date)] Ошибка при передаче на удаленный сервер!"
    exit 1
fi

# Удаление старых резервных копий
echo "[$(date)] Удаление резервных копий старше $RETENTION_DAYS дней..."
find $BACKUP_DIR -name "mediawiki_fs_*.tar.gz" -mtime +$RETENTION_DAYS -exec rm -f {} \;
ssh $REMOTE_USER@$REMOTE_HOST "find $REMOTE_DIR -name 'mediawiki_fs_*.tar.gz' -mtime +$RETENTION_DAYS -exec rm -f {} \\;"

echo "[$(date)] Резервное копирование файловой системы завершено успешно."
exit 0
