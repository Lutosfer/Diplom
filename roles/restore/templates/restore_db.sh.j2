#!/bin/bash

# Конфигурация
LOCAL_BACKUP_DIR="/backup/database"
REMOTE_HOST="158.160.105.109"
REMOTE_USER="ubuntu"
REMOTE_BACKUP_DIR="/backup"
DB_NAME="my_wiki"
DB_USER="wiki_user"

# Поиск последней резервной копии
BACKUP_FILE=$(ls -t $LOCAL_BACKUP_DIR/mediawiki_db_*.sql.gz | head -n1)
if [ -z "$BACKUP_FILE" ]; then
    echo "Ошибка: Не найдено резервных копий"
    exit 1
fi
BACKUP_FILENAME=$(basename $BACKUP_FILE)

# Отправка резервной копии на удаленный сервер
scp $BACKUP_FILE $REMOTE_USER@$REMOTE_HOST:$REMOTE_BACKUP_DIR/$BACKUP_FILENAME

# Выполнение восстановления на удаленном сервере
ssh $REMOTE_USER@$REMOTE_HOST << EOF
    # Остановка веб-сервера
    sudo systemctl stop nginx

    # Восстановление базы данных
    zcat $REMOTE_BACKUP_DIR/$BACKUP_FILENAME | sudo -u $DB_USER psql -d $DB_NAME
    
    # Перезапуск веб-сервера
    sudo systemctl start nginx
EOF

echo "Восстановление базы данных завершено"

